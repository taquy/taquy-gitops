version: '3'

volumes:
  nginx-logs-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/nginx/logs
  jenkins-cache-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/jenkins/cache
  jenkins-logs-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/jenkins/logs
  octopus-repository-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/octopus/repository
  octopus-artifacts-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/octopus/artifacts
  octopus-taskLogs-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/octopus/taskLogs
  octopus-cache-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/octopus/cache
  octopus-import-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/octopus/import
  mssql-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /data/mssql

services:
  nginx:
    container_name: nginx
    image: 397818416365.dkr.ecr.us-east-1.amazonaws.com/nginx:latest
    user: root
    privileged: true
    restart: unless-stopped
    volumes:
      - nginx-logs-data:/var/log/nginx
    network_mode: host
  jenkins:
    container_name: jenkins
    image: 397818416365.dkr.ecr.us-east-1.amazonaws.com/jenkins:latest
    user: root
    privileged: true
    restart: always
    ports:
      - 9091:8080
    environment:
      JENKINS_USER: root
      JENKINS_PASS: root1234
      JAVA_OPTS: -Xmx8192m -Djenkins.install.runSetupWizard=false
      JENKINS_OPTS: --argumentsRealm.roles.user=admin --argumentsRealm.passwd.admin=admin --argumentsRealm.roles.admin=admin
    volumes:
      - jenkins-cache-data:/var/cache/jenkins
      - jenkins-logs-data:/var/log/jenkins
  mssql:
    container_name: mssql
    image: microsoft/mssql-server-linux
    user: root
    privileged: true
    restart: always
    environment:
      SA_PASSWORD: "aD@R98xaYEctkKCn"
      ACCEPT_EULA: "Y"
    ports:
      - 1433:1433
    healthcheck:
      test: [ "CMD", "/opt/mssql-tools/bin/sqlcmd", "-U", "sa", "-P", "aD@R98xaYEctkKCn", "-Q", "select 1"]
      interval: 10s
      retries: 10
    volumes:
      - mssql-data:/var/opt/mssql
  octopus:
    container_name: octopus
    image: octopusdeploy/octopusdeploy:latest
    user: root
    privileged: true
    restart: always
    ports:
      - 9090:8080
      - 11111:10943
    environment:
      ACCEPT_EULA: "Y"
      OCTOPUS_SERVER_NODE_NAME: taquy
      DB_CONNECTION_STRING: Server=mssql,1433;Database=OctopusDeploy;User=sa;Password=aD@R98xaYEctkKCn
      ADMIN_USERNAME: root
      ADMIN_PASSWORD: aD@R98xaYEctkKCn
      ADMIN_EMAIL: taquy.pb@gmail.com
      # openssl rand 16 | base64
      MASTER_KEY: txEh15FjdRzdNhLroMNb1w==
      ServerApiKey: 
      DISABLE_DIND: "Y"
    depends_on:
      - mssql
    volumes:
      - octopus-repository-data:/repository
      - octopus-artifacts-data:/artifacts
      - octopus-taskLogs-data:/taskLogs
      - octopus-cache-data:/cache
      - octopus-import-data:/import
  octopus-tentacle:
    depends_on:
      - octopus
    container_name: octopus-tentacle
    image: octopusdeploy/tentacle:latest
    user: root
    privileged: true
    restart: always
    publish:
      - 10931:10933
    environment:
      ServerUsername: root
      ServerPassword: aD@R98xaYEctkKCn
      TargetName: octopus-deploy
      ListeningPort: 10931
      TargetEnvironment: api.taquy.com
      ServerUrl: https://octopus.taquy.com
      PublicHostNameConfiguration: https://octopus-tentacle.taquy.com
      ACCEPT_EULA: "Y"